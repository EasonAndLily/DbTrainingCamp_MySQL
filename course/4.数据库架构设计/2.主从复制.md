# 数据库主从复制

![master-slave-architecture](https://tva1.sinaimg.cn/large/008i3skNly1gs2yspo1n3j30ho09q74g.jpg)

对于Web服务器来说，如果出现性能瓶颈，只要Web服务没有状态的区别，我们可以横向增加多台Web服务器来解决。但是对于数据库来说，这种方式就显得有些力不从心，处理不好，非常容易造成多台机器上面的数据库存储数据的不一致，导致数据异常，所以，数据库的架构设计显得尤为重要。

## 主从复制架构

通常情况下，我们采用主从`复制架构`来解决性能瓶颈, 所谓主从复制，就是将数据库所在机器中读写性能最好的那台服务器作为`主数据库(master)`, 此数据库通常用来接受`数据更改的请求`，同时，我们会构建多个`从服务器数据库`, 作为主数据库的备库，以应对大量的`读请求`, 由于主从数据库之间的延时很低，所以，`主从复制`架构主要是通过`读写`分离来增加吞吐量来提升性能。

![mysql-replication](https://tva1.sinaimg.cn/large/008i3skNly1gs2za5cf2wj30d0093jrv.jpg)

从上图可知，MySQL的主从复制的实现依赖于binarylog，主要经历以下几个过程：

1. Master数据库将变更写入binarylog中。
2. Slave数据库从Master数据库binglog中读取日志变更写入到RelayLog中。要完成这个步骤，Slave数据库首先需要在本机启动一个I/O线程用于读取Master数据库的变更日志，此线程会对Master数据库中的日志进行轮询，如果Master数据库中的日志有更新，则迅速读取到Slave数据库机器上，如果没有更新，则进入休眠状态，直到master数据库有更新时才会通知此线程，此线程将再次回到工作状态。
3. 在Slave数据库上将RelayLog的数据写入Slave数据库中，完成数据的复制。

## 段日志和行日志的差异

根据写入方式的不同，可以分为基于SQL段的日志和基于行的日志读取。这两种方式我们前面已经有所了解，这里我们就简单的对比一下这两种方式的差异：
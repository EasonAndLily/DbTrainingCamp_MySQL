# 高可用架构

![high-avaliable-architecture](https://tva1.sinaimg.cn/large/008i3skNly1gsddenbmrrj307n053747.jpg)

归根结底，高可用性实际上意味着“更少的宕机时间”，然而更糟糕的是，高可用性经常和其他相关的概念相混淆，例如冗余、数据可靠性以及负载均衡。高可用性实际上有点像神秘的野兽，今天我们就来战胜它！

## 什么是高可用性？

高可用性通常以百分比来表示，意味着高可用性不是绝对的，只有相对更高的可用性。100%的可用性是不可能达到的。可用性的`9`规则是表示可用性目标最普遍的方法。你可能也知道，`5个9`表示`99.999%`的正常可用时间，换句话说，每年只允许5分钟的宕机时间。对于大多数应用来说，这是一个令人惊叹的数字，尽管还有一些人视图获得更多的额`9`!

在设定一个可用时间的目标之前，先问问自己，是不是确实需要达到这个目标。可用性每提高一点，所花费的成本都会远高于之前，可用性的效果和开销的比例并不是线性的。需要保证多少可用时间，取决于能够承担多少成本。

***高可用性实际上是在宕机造成的损失与降低宕机时间所花费的成本之间取得一个平衡！***

幸运的是，简历`2个9`或`3个9`的可用时间的目标可能并不困难，具体情况取决于应用。

## 是什么导致了宕机？

到底是什么原因导致宕机呢？这是一个很普遍但是很难猜测的话题，这里我们列举一些常见的宕机情况：

* 在运行环境中，最普遍的问题是磁盘空间耗尽。
* 在性能问题中，最普遍的宕机原因确实是运行很糟糕的SQL，但也不一定都是这个原因，比如也有很多问题是由于服务器Bug或错误的行为导致的。
* 糟糕的Schema和索引设计是第二大影响性能的问题。
* 复制问题通常由于主备数据不一致导致。
* 数据丢失问题通常由于Drop Table的错误操作导致，并总是伴随着缺少可用备份的问题。

## 如何实现高可用性？

可以通过同时进行以下两步来获得高可用性。

第一: 可以尝试避免导致宕机的原因来减少宕机时间。许多问题其实很容易避免，例如通过适当的配置、监控，以及规范或安全保证措施来避免人为造成的错误。

第二：尽量保证在发生宕机时能够快速恢复，最常见的测试是在系统中制造冗余，并且具备故障转移能力。

这两个维度的高可用性可以通过两个相关的度量来确定：`平均失效时间(MTBF)`和`平均恢复时间(MTTR)`。下面我们就这两个维度来看看对应的实现高可用性的方案。

### 提升平均失效时间(MTBF)

其实，尽职尽责的做好一些应该做的事情，就可以避免很多宕机。下面我们列举一些常见的事项：

* 测试恢复工具和流程，包括从备份中恢复数据。
* 遵从最小权限原则。
* 使用InnoDB并进行适当的配置，确保InnoDB是默认的存储引擎。如果存储引擎被禁止，服务就无法启动。
* 监控重要的组件和功能，特别是像磁盘空间和RAID卷状态这样的关键项目，但也要避免误报，只有当确实发生问题时才发送警告。
* 定期检查复制完整性。
* 将备库设置为只读，不要让复制自动启动。
* 归档并清理不需要的数据。
* 为文件系统保留一些空间。

### 降低平均恢复时间(MTTR)

在降低恢复时间上进行投资非常重要，一个能够提供冗余和故障转移能力的系统架构，则是降低恢复时间的关键环节。

团队成员是最重要的高可用性资产，所以为恢复制定一个好的流程非常重要。拥有熟练技能，应变能力，训练有素的雇员，以及处理紧急事件的详细文档和经过仔细测试的流程，对从宕机中恢复有巨大的作用。

这里我们反复提醒，所有的宕机事件都是由多方面的失效联合在一起导致的，因此，可以通过利用合适的方法确保单点的安全来避免。整个链条必须要打断，而不仅仅是单个环节。

找到并消除系统中的可能失效的单点，并结合切换到备用组件的机制，这是一种通过减少恢复时间(MTTR)来改善可用性的方法。

***系统中任何不冗余的部分都是一个可能失效的单点。***

单点失效并不总是能够消除。增加冗余或许也无法做到，因为有些限制无法避开，例如地理位置，预算或者时间限制等。试着去理解每一个影响可用性的部分，采取一种平衡的观点来看待风险，并首先解决其中影响最大的那个。

可以采用两种方法为系统增加冗余：增加空余容量和重复组件。一个提升可用性的方法是创建一个集群或者服务池，并使用负载均衡的解决方案。同时，基于复制的冗余对避免单点故障意义重大，这在主要组件失效时能有一个备件随时替换。

常见的基于复制的冗余架构管理组件有：MMM架构和MHA架构，后面的课程我们将重点介绍。